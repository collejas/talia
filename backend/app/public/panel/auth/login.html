<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1020" />
  <title>TalIA • Acceso</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="/api/shared/logos/Logo8.svg" />
  <link rel="icon" type="image/png" sizes="32x32" href="/api/shared/logos/favicon-32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/api/shared/logos/favicon-16.png" />
  <link rel="icon" type="image/x-icon" href="/api/shared/logos/favicon.ico" />
  <link rel="apple-touch-icon" href="/api/shared/logos/Logo7.png" />
  <link rel="stylesheet" href="../assets/css/base.css" />
  <script src="/api/panel/env.js"></script>
  <style>
    .card{max-width:420px;margin:40px auto 0;padding:18px;border:1px solid var(--border-soft);border-radius:14px;background:var(--surface)}
    .row{display:flex;flex-direction:column;gap:10px}
    .input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border-strong);background:var(--surface-alt);color:var(--fg)}
    .muted{color:var(--muted)}
    .login-brand{display:flex;align-items:center;justify-content:center;gap:10px;margin:64px auto 8px}
    .login-brand .brand-icon{width:64px;height:64px}
    .login-brand .logo{width:64px;height:64px;font-size:1.2rem}
    .login-brand .brand-text{font-size:2rem}
  </style>
  <script src="../assets/js/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="theme-aurora" data-nav="">
  <main class="container" style="padding:24px 0 40px;">
    <div class="brand login-brand" aria-label="TalIA">
      <img class="brand-icon" src="/api/shared/logos/Logo8.png" alt="TalIA logo" />
      <span class="brand-text">Tal-<span class="logo">IA</span></span>
    </div>
    <div class="card">
      <h2 style="margin:6px 0 12px">Accede a tu panel</h2>
      <div class="row">
        <input id="email" class="input" type="email" placeholder="Email" />
        <input id="password" class="input" type="password" placeholder="Contraseña" />
        <button id="login" class="btn">Ingresar</button>
        <div id="msg" class="muted"></div>
      </div>
    </div>
  </main>

  <!-- Inicializa Supabase con fallback dinámico solo si el bundle global no cargó -->
  <script type="module">
    const msgEl = document.getElementById('msg');
    const setMessage = (text) => {
      if (msgEl) msgEl.textContent = text || '';
    };

    const supabaseUrl = (window.SUPABASE_URL || '').trim();
    const supabaseAnon = (window.SUPABASE_ANON_KEY || '').trim();

    console.debug('[Panel] login init', {
      hasSupabase: !!window.supabase,
      hasUrl: !!supabaseUrl,
      hasAnon: !!supabaseAnon,
    });

    if (!supabaseUrl || !supabaseAnon) {
      setMessage('Configura SUPABASE_URL y SUPABASE_ANON_KEY');
    } else {
      const ensureClient = async () => {
        if (window.supabase?.createClient) {
          return window.supabase.createClient(supabaseUrl, supabaseAnon);
        }
        try {
          const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
          console.info('[Panel] Usando fallback ESM para Supabase.');
          return createClient(supabaseUrl, supabaseAnon);
        } catch (error) {
          console.error('[Panel] No se pudo cargar Supabase vía fallback.', error);
          throw error;
        }
      };

      const setupLogin = async () => {
        let client;
        try {
          client = await ensureClient();
        } catch (error) {
          setMessage('Error cargando autenticación');
          return;
        }

        const onLogin = async () => {
          const email = document.getElementById('email')?.value.trim() || '';
          const password = document.getElementById('password')?.value || '';
          if (!email || !password) {
            setMessage('Completa usuario y contraseña');
            return;
          }
          setMessage('Ingresando...');
          try {
            const { error } = await client.auth.signInWithPassword({ email, password });
            if (error) {
              setMessage(error.message || 'Error de autenticación');
              return;
            }
            setMessage('Listo, redirigiendo...');
            window.location.href = '../panel.html';
          } catch (error) {
            console.error('[Panel] login error', error);
            setMessage('Error de red al iniciar sesión');
          }
        };

        const btn = document.getElementById('login');
        if (btn) btn.addEventListener('click', onLogin);
        document.addEventListener('keydown', (event) => {
          if (event.key === 'Enter') onLogin();
        });
      };

      setupLogin();
    }
  </script>
  <script type="module" src="../assets/js/common.js"></script>
</body>
</html>
