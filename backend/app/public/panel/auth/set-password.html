<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1020" />
  <title>TalIA • Restablecer contraseña</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/base.css" />
  <script src="/api/panel/env.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .card{max-width:480px;margin:80px auto 0;padding:18px;border:1px solid var(--border-soft);border-radius:14px;background:var(--surface)}
    .row{display:flex;flex-direction:column;gap:10px}
    .input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border-strong);background:var(--surface-alt);color:var(--fg)}
    .muted{color:var(--muted)}
  </style>
</head>
<body class="theme-aurora">
  <header class="nav">
    <div class="container nav-inner">
      <a class="brand" href="../panel.html">
        <span class="logo">AI</span>
        <span class="brand-text">TalIA Panel</span>
      </a>
      <nav class="menu">
        <a href="../panel.html" class="btn btn-outline">Dashboard</a>
        <a href="../inbox.html" class="btn btn-outline">Inbox</a>
        <a href="../configuracion.html" class="btn btn-outline">Configuración</a>
        <div class="theme-switcher">
          <select id="panel-theme-select" class="btn btn-outline" aria-label="Cambiar tema visual">
            <option value="theme-aurora">Aurora violeta</option>
            <option value="theme-ice">Espectro vibrante</option>
            <option value="theme-void">Nocturno</option>
          </select>
        </div>
      </nav>
    </div>
  </header>

  <main class="container" style="padding:24px 0 40px;">
    <div class="card">
      <h2 style="margin:6px 0 12px">Restablecer contraseña</h2>
      <div id="step-session" class="row" style="display:none">
        <div class="muted">Verificando enlace...</div>
      </div>
      <div id="step-form" class="row" style="display:none">
        <input id="pwd1" class="input" type="password" placeholder="Nueva contraseña" />
        <input id="pwd2" class="input" type="password" placeholder="Confirmar contraseña" />
        <button id="btn-set" class="btn">Guardar nueva contraseña</button>
        <div id="msg" class="muted"></div>
      </div>
      <div id="step-done" class="row" style="display:none">
        <div>Tu contraseña fue actualizada.</div>
        <a class="btn btn-outline" href="./login.html">Ir al login</a>
      </div>
      <div id="step-error" class="row" style="display:none">
        <div id="err" class="muted"></div>
        <a class="btn btn-outline" href="./login.html">Volver al login</a>
      </div>
    </div>
  </main>

  <script>
    (async function(){
      const msg = (t) => { const el = document.getElementById('msg'); if (el) el.textContent = t; };
      const show = (id) => { for (const s of ['step-session','step-form','step-done','step-error']){ const el = document.getElementById(s); if (el) el.style.display = (s===id?'block':'none'); } };
      try {
        show('step-session');
        // Lee tokens del fragmento de la URL (#access_token=...&refresh_token=...)
        const params = new URLSearchParams(window.location.hash.slice(1));
        const access_token = params.get('access_token');
        const refresh_token = params.get('refresh_token');
        if (!window.supabase || !window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
          document.getElementById('err').textContent = 'Falta configuración del cliente';
          show('step-error');
          return;
        }
        const sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        if (!access_token || !refresh_token) {
          document.getElementById('err').textContent = 'Enlace inválido o expirado';
          show('step-error');
          return;
        }
        // Establece la sesión con los tokens del enlace de recuperación
        const { error: setErr } = await sb.auth.setSession({ access_token, refresh_token });
        if (setErr) {
          document.getElementById('err').textContent = setErr.message || 'No fue posible validar el enlace';
          show('step-error');
          return;
        }
        // Mostrar formulario para nueva contraseña
        show('step-form');
        document.getElementById('btn-set').addEventListener('click', async () => {
          const p1 = document.getElementById('pwd1').value;
          const p2 = document.getElementById('pwd2').value;
          if (!p1 || p1.length < 8) { msg('Usa al menos 8 caracteres'); return; }
          if (p1 !== p2) { msg('Las contraseñas no coinciden'); return; }
          msg('Actualizando...');
          const { error: updErr } = await sb.auth.updateUser({ password: p1 });
          if (updErr) { msg(updErr.message || 'No fue posible actualizar la contraseña'); return; }
          show('step-done');
        });
      } catch (e) {
        console.error('[Panel] reset error', e);
        document.getElementById('err').textContent = 'Error al procesar el enlace';
        show('step-error');
      }
    })();
  </script>
  <script type="module" src="../assets/js/common.js"></script>
</body>
</html>
